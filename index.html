<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰ºæœ¯å­¦æ¦‚è®º - AI æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .cloze-mask { background-color: #4f46e5; color: transparent; border-radius: 4px; padding: 0 4px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.1); user-select: none; }
        .cloze-mask.revealed { background-color: #e0e7ff; color: #3730a3; font-weight: 600; }
        .term-blur { filter: blur(8px); user-select: none; background: #e2e8f0; color: transparent; cursor: pointer; transition: all 0.5s ease; }
        .term-blur:hover { filter: blur(4px); }
        .term-revealed { filter: blur(0); background: transparent; color: #334155; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .markdown-editor { font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; line-height: 1.6; }
        .seg-original { color: #1e293b; font-weight: 500; background-color: #f1f5f9; padding: 0 2px; border-radius: 2px; border-bottom: 2px solid #cbd5e1; }
        .seg-ai { color: #64748b; font-style: italic; font-size: 0.95em; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

<div id="app" class="flex w-full h-full relative">

    <!-- API é…ç½®æ¨¡æ€æ¡† -->
    <div v-if="showConfigModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="ri-settings-4-line text-indigo-600"></i> AI æ¨¡å‹é…ç½®
                </h3>
                <button @click="showConfigModal = false" class="text-slate-400 hover:text-slate-600"><i class="ri-close-line text-2xl"></i></button>
            </div>

            <div class="space-y-5">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <span class="text-xs font-bold text-slate-400 uppercase mb-3 block tracking-wider">ä¸€é”®é¢„è®¾</span>
                    <div class="grid grid-cols-3 gap-2">
                        <button @click="loadPreset('hzau')" class="py-2 px-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-green-600 hover:border-green-400 hover:bg-green-50 transition flex flex-col items-center gap-1">
                            <i class="ri-plant-fill text-lg"></i> Hzau Agent
                        </button>
                        <button @click="loadPreset('deepseek')" class="py-2 px-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition flex flex-col items-center gap-1">
                            <i class="ri-flashlight-fill text-lg"></i> DeepSeek
                        </button>
                        <button @click="loadPreset('gemini')" class="py-2 px-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-teal-600 hover:border-teal-400 hover:bg-teal-50 transition flex flex-col items-center gap-1">
                            <i class="ri-google-fill text-lg"></i> Gemini
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">æ¥å£åè®®ç±»å‹</label>
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button @click="aiConfig.provider = 'custom'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all', aiConfig.provider === 'custom' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500 hover:text-slate-700']">
                            è‡ªå®šä¹‰åº”ç”¨ (Hzau)
                        </button>
                        <button @click="aiConfig.provider = 'openai'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all', aiConfig.provider === 'openai' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700']">
                            æ ‡å‡† OpenAI
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">
                        {{ aiConfig.provider === 'custom' ? 'Base URL (ä¸å« /application...)' : 'API Endpoint' }}
                    </label>
                    <input type="text" v-model="aiConfig.baseUrl" :placeholder="aiConfig.provider === 'custom' ? 'https://agent.hzau.edu.cn/api' : 'https://api.openai.com/v1'" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-xs font-mono">
                    <p class="text-xs text-slate-400 mt-1" v-if="aiConfig.provider === 'custom'">ä¼šè‡ªåŠ¨è¿½åŠ  <code>/application/chat_message/{uuid}</code></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">API Key / Application ID</label>
                    <input type="password" v-model="aiConfig.key" placeholder="sk-..." class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-xs font-mono">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Model Name <span class="text-gray-400 font-normal text-xs">(é€‰å¡«)</span></label>
                    <input type="text" v-model="aiConfig.model" placeholder="gpt-3.5-turbo" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-xs font-mono">
                </div>
            </div>

            <div class="mt-8 flex items-center justify-between pt-4 border-t border-slate-50">
                <div class="flex items-center gap-2">
                    <span :class="['w-2 h-2 rounded-full', connectionStatus === 'success' ? 'bg-green-500' : connectionStatus === 'error' ? 'bg-red-500' : 'bg-slate-300']"></span>
                    <span class="text-xs text-slate-500">{{ connectionMsg || 'ç­‰å¾…æµ‹è¯•...' }}</span>
                </div>
                <div class="flex gap-3">
                    <button @click="testConnection" :disabled="isTesting" class="px-4 py-2 bg-slate-50 text-slate-600 rounded-lg hover:bg-slate-100 text-sm font-bold transition flex items-center gap-2">
                        <div v-if="isTesting" class="loader !border-slate-400 !border-t-transparent !w-4 !h-4"></div>
                        æµ‹è¯•è¿æ¥
                    </button>
                    <button @click="saveConfig" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-bold shadow-lg shadow-indigo-200 transition">
                        ä¿å­˜å¹¶åº”ç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <aside class="w-20 lg:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
        <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-50">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md">
                <i class="ri-brain-line"></i>
            </div>
            <span class="ml-3 font-bold text-slate-700 hidden lg:block tracking-tight">AI ArtOS</span>
        </div>

        <nav class="flex-1 p-2 space-y-1 mt-4">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="['w-full flex items-center px-3 py-3 rounded-xl transition-all duration-200 group relative', currentTab === tab.id ? 'bg-indigo-50 text-indigo-600 font-medium' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700']">
                <i :class="[tab.icon, 'text-xl']"></i>
                <span class="ml-3 hidden lg:block">{{ tab.name }}</span>
                <div class="lg:hidden absolute left-14 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50">{{ tab.name }}</div>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-100">
            <button @click="showConfigModal = true" class="w-full flex items-center justify-center lg:justify-start px-3 py-2 rounded-lg text-slate-500 hover:bg-slate-100 hover:text-indigo-600 transition">
                <i class="ri-settings-3-line text-lg"></i>
                <span class="ml-2 hidden lg:block text-sm">æ¨¡å‹è®¾ç½®</span>
                <span v-if="!aiConfig.key && aiConfig.provider === 'openai'" class="absolute top-4 right-4 w-2 h-2 bg-red-500 rounded-full animate-pulse lg:hidden"></span>
            </button>
        </div>
    </aside>

    <!-- ä¸»ç•Œé¢ -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-[#f1f5f9]">

        <header class="h-16 bg-white/80 backdrop-blur-md border-b border-white/50 px-6 flex items-center justify-between z-10 sticky top-0 shadow-sm">
            <div class="flex items-center gap-4">
                <h2 class="font-bold text-slate-800 text-lg hidden md:block">{{ currentTabName }}</h2>
                <div class="flex items-center bg-slate-100 rounded-lg px-3 py-1.5 border border-slate-200">
                    <i class="ri-book-mark-line text-indigo-500 mr-2"></i>
                    <select v-model="selectedChapter" class="bg-transparent text-sm font-medium text-slate-700 focus:outline-none min-w-[150px] max-w-[200px] truncate">
                        <option value="">ğŸ“š å…¨ä¹¦ç»¼åˆæ¨¡å¼</option>
                        <option v-for="(chap, idx) in chapterList" :key="idx" :value="chap">{{ chap }}</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2">
                    <span v-if="!aiConfig.key && aiConfig.provider === 'openai'" class="text-xs text-red-500 bg-red-50 px-2 py-1 rounded-full flex items-center gap-1">
                        <i class="ri-error-warning-line"></i> æœªé…ç½® Key
                    </span>
                <span v-else class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1 cursor-help" :title="aiConfig.baseUrl">
                        <i :class="aiConfig.provider === 'custom' ? 'ri-cpu-line' : 'ri-robot-2-line'"></i>
                        {{ aiConfig.provider === 'custom' ? 'Custom App' : (aiConfig.model || 'AI').slice(0, 15) + '...' }}
                    </span>
            </div>
        </header>

        <!-- 1. MDæ€ç»´å¯¼å›¾æ¨¡å— -->
        <div v-show="currentTab === 'mindmap'" class="flex-1 flex overflow-hidden p-4 gap-4">
            <div class="w-1/3 glass-panel rounded-2xl flex flex-col min-w-[300px]">
                <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-white/50 rounded-t-2xl">
                    <span class="text-sm font-bold text-slate-600">Markdown æºç </span>
                    <div class="flex gap-2">
                        <button @click="$refs.fileInput.click()" class="text-xs bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-50 transition flex items-center gap-1">
                            <i class="ri-upload-2-line"></i> å¯¼å…¥
                        </button>
                        <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden" accept=".md,.txt">
                        <button @click="renderMindMap" class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-200 transition">åˆ·æ–°</button>
                    </div>
                </div>
                <textarea v-model="markdownSource" class="flex-1 w-full p-4 bg-transparent resize-none focus:outline-none markdown-editor text-sm text-slate-700 custom-scrollbar" placeholder="# æ ¹èŠ‚ç‚¹\n## å­èŠ‚ç‚¹"></textarea>
            </div>

            <div class="flex-1 glass-panel rounded-2xl flex flex-col relative overflow-hidden">
                <div class="absolute top-4 left-4 z-10 flex gap-2">
                    <div class="relative">
                        <i class="ri-search-line absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="text" v-model="mapSearchQuery" @keyup.enter="searchMindMap" placeholder="æœç´¢èŠ‚ç‚¹..." class="pl-9 pr-4 py-2 rounded-full border border-slate-200 bg-white/80 shadow-sm focus:ring-2 focus:ring-indigo-500 w-64 text-sm transition-all">
                    </div>
                </div>
                <div class="absolute top-4 right-4 z-10">
                    <button @click="resetMindMapZoom" class="bg-white/80 p-2 rounded-lg shadow-sm border border-slate-200 hover:bg-white text-slate-500 hover:text-indigo-600 transition" title="é‡ç½®è§†å›¾">
                        <i class="ri-fullscreen-exit-line"></i>
                    </button>
                </div>
                <div id="mindmap-container" class="w-full h-full rounded-2xl cursor-move"></div>
            </div>
        </div>

        <!-- 2. AI åè¯è§£é‡Šæ¨¡å— -->
        <div v-show="currentTab === 'terms'" class="flex-1 overflow-y-auto p-6 lg:p-10 flex flex-col items-center">
            <div class="w-full max-w-4xl">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">åè¯è§£é‡Šç‰¹è®­ (æº¯æºæ¨¡å¼)</h2>
                    <p class="text-slate-500 mt-2">
                        å½“å‰èŒƒå›´ï¼š<span class="font-bold text-indigo-600">{{ selectedChapter || 'å…¨ä¹¦ç»¼åˆ (æ™ºèƒ½åˆ‡ç‰‡)' }}</span>
                    </p>
                    <div class="mt-6 flex justify-center">
                        <button @click="generateTermsBatch" :disabled="isAiProcessing" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition disabled:opacity-50 flex items-center justify-center gap-2">
                            <div v-if="isAiProcessing" class="loader !border-white !border-t-transparent !w-5 !h-5"></div>
                            {{ isAiProcessing ? 'ç»“æ„åŒ–æå–ä¸­...' : 'ğŸ² éšæœºç”Ÿæˆä¸€ç»„ (5é¢˜)' }}
                        </button>
                    </div>
                </div>

                <div v-if="termList.length > 0" class="grid gap-6 animate-fade-in-up pb-10">
                    <div v-for="(item, index) in termList" :key="index" class="glass-panel rounded-xl p-6 transition-all hover:shadow-md">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <span class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center font-bold text-sm">{{ index + 1 }}</span>
                                <h3 class="text-xl font-bold text-slate-800">{{ item.term }}</h3>
                            </div>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded border border-slate-200 truncate max-w-[150px]" :title="item.chapter">
                                    <i class="ri-map-pin-line"></i> {{ item.chapter }}
                                </span>
                        </div>

                        <div v-if="item.context" class="mb-4 bg-amber-50 border-l-4 border-amber-400 p-3 rounded-r text-sm text-amber-800">
                            <span class="font-bold block mb-1"><i class="ri-lightbulb-line"></i> è¯­å¢ƒçº¿ç´¢ï¼š</span>
                            {{ item.context }}
                        </div>

                        <div class="relative rounded-lg bg-white border border-slate-200 p-5 cursor-pointer group" @click="item.revealed = !item.revealed">
                            <div v-if="item.revealed">
                                <div class="flex gap-4 mb-3 text-xs border-b border-slate-100 pb-2">
                                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-slate-100 border-b-2 border-slate-300 rounded-sm"></span> <span class="text-slate-600 font-bold">åŸæ–‡å¼•ç”¨</span></div>
                                    <div class="flex items-center gap-1"><span class="text-slate-400 italic font-serif">Ag</span> <span class="text-slate-400 italic">AIè¾…åŠ©è¯´æ˜</span></div>
                                </div>
                                <div class="leading-relaxed text-justify space-y-1">
                                        <span v-for="(seg, sIdx) in item.segments" :key="sIdx"
                                              :class="seg.is_original ? 'seg-original' : 'seg-ai'">
                                            {{ seg.text }}
                                        </span>
                                </div>
                            </div>
                            <div v-else class="h-24 flex items-center justify-center bg-slate-50 rounded">
                                    <span class="bg-white border border-slate-200 text-slate-500 px-4 py-2 rounded-full text-sm font-bold shadow-sm flex items-center gap-2 group-hover:text-indigo-600 group-hover:border-indigo-200 transition">
                                        <i class="ri-eye-close-line"></i> ç‚¹å‡»æ­æ™“ç­”æ¡ˆ
                                    </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="!isAiProcessing" class="text-center text-slate-400 py-20">
                    <i class="ri-inbox-line text-5xl mb-4 block opacity-30"></i>
                    <p>æš‚æ— é¢˜ç›®ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ·±åº¦æŒ–æ˜</p>
                </div>
            </div>
        </div>

        <!-- 3. AI èƒŒè¯µæ£€æµ‹æ¨¡å— (æ‰¹é‡3é¢˜) -->
        <div v-show="currentTab === 'recite'" class="flex-1 overflow-y-auto p-6 lg:p-10">
            <div class="max-w-5xl mx-auto space-y-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">AI æ™ºèƒ½æŒ–ç©ºèƒŒè¯µ</h2>
                    <p class="text-slate-500 mt-2 text-sm">åˆ‡ç‰‡èŒƒå›´ï¼šæ™ºèƒ½åˆ‡ç‰‡ | æ‰¹é‡ç”Ÿæˆï¼š3é¢˜</p>
                    <button @click="generateReciteBatch" :disabled="isAiProcessing" class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 transition disabled:opacity-50 flex items-center justify-center gap-2 mx-auto">
                        <div v-if="isAiProcessing" class="loader !border-white !border-t-transparent !w-4 !h-4"></div>
                        {{ isAiProcessing ? 'æ­£åœ¨åˆ†æåˆ‡ç‰‡å¹¶æŒ–ç©º...' : 'âœ¨ éšæœºç”Ÿæˆ 3 é“å¡«ç©ºé¢˜' }}
                    </button>
                </div>

                <div v-if="reciteList.length > 0" class="grid gap-8 animate-fade-in-up pb-10">
                    <div v-for="(item, index) in reciteList" :key="index" class="glass-panel p-8 rounded-2xl border-l-4 border-indigo-500 relative">
                        <div class="absolute top-0 right-0 bg-slate-100 text-slate-500 px-3 py-1 rounded-bl-xl text-xs font-bold border-b border-l border-slate-200">
                            é¢˜å· #{{ index + 1 }}
                        </div>
                        <div class="text-lg leading-loose text-slate-700 text-justify">
                            <template v-for="(segment, sIdx) in item.segments" :key="sIdx">
                                <span v-if="segment.type === 'text'">{{ segment.content }}</span>
                                <span v-else
                                      @click="segment.revealed = !segment.revealed"
                                      :class="['cloze-mask mx-1 select-none px-2', segment.revealed ? 'revealed' : '']">
                                        {{ segment.content }}
                                    </span>
                            </template>
                        </div>
                    </div>
                </div>

                <div v-else-if="!isAiProcessing" class="text-center text-slate-400 py-12">
                    <i class="ri-eraser-line text-5xl mb-4 block opacity-30"></i>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆå¡«ç©ºé¢˜</p>
                </div>
            </div>
        </div>

        <!-- 4. AI æ¨¡æ‹Ÿæµ‹è¯•æ¨¡å— (5é¢˜å«ä¸å®šé¡¹) -->
        <div v-show="currentTab === 'quiz'" class="flex-1 flex flex-col overflow-hidden relative">
            <div class="flex-1 overflow-y-auto p-6 lg:p-10 flex flex-col items-center">

                <!-- åˆå§‹çŠ¶æ€ -->
                <div v-if="quizQueue.length === 0" class="max-w-lg w-full text-center mt-10">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="ri-survey-line text-4xl text-indigo-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">AI ç« èŠ‚è€ƒå‰æ¨¡æ‹Ÿ</h2>
                    <p class="text-slate-500 mb-8">
                        åˆ‡ç‰‡èŒƒå›´ï¼šæ™ºèƒ½åˆ‡ç‰‡ | é¢˜é‡ï¼š5é¢˜ (å«ä¸å®šé¡¹)
                    </p>

                    <button @click="generateQuizBatch" :disabled="isAiProcessing" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition disabled:opacity-50 flex items-center justify-center gap-2">
                        <i v-if="!isAiProcessing" class="ri-play-circle-line text-xl"></i>
                        <div v-else class="loader !w-4 !h-4 !border-white !border-t-transparent"></div>
                        {{ isAiProcessing ? 'æ­£åœ¨å‡ºé¢˜ (5é¢˜)...' : 'å¼€å§‹æµ‹è¯•' }}
                    </button>
                </div>

                <!-- ç­”é¢˜å¡ç‰‡ -->
                <div v-else class="w-full max-w-2xl animate-fade-in-up">
                    <div class="glass-panel rounded-2xl p-8 lg:p-10 relative">
                        <div class="flex justify-between items-center mb-6">
                                <span :class="['px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide',
                                    quizQueue[currentQuizIndex].type === 'multiple' ? 'bg-purple-100 text-purple-700' : 'bg-indigo-100 text-indigo-700']">
                                    {{ quizQueue[currentQuizIndex].type === 'multiple' ? 'ä¸å®šé¡¹é€‰æ‹©é¢˜' : 'å•é¡¹é€‰æ‹©é¢˜' }}
                                </span>
                            <span class="text-slate-400 font-mono text-sm">
                                    {{ currentQuizIndex + 1 }} / {{ quizQueue.length }}
                                </span>
                        </div>

                        <h3 class="text-xl font-bold text-slate-800 mb-8 leading-relaxed">{{ quizQueue[currentQuizIndex].question }}</h3>

                        <div class="space-y-4">
                            <button v-for="(opt, idx) in quizQueue[currentQuizIndex].options" :key="idx"
                                    @click="selectOption(idx)"
                                    :disabled="quizAnswered && quizQueue[currentQuizIndex].type === 'single'"
                                    :class="['w-full text-left p-5 rounded-xl border transition-all flex items-center justify-between group relative overflow-hidden',
                                    getOptionClass(idx)]">

                                <div class="flex items-center gap-4 z-10">
                                    <!-- Checkbox/Radio Icon -->
                                    <div :class="['w-6 h-6 rounded border flex items-center justify-center transition-colors',
                                            quizQueue[currentQuizIndex].type === 'multiple' ? 'rounded-md' : 'rounded-full',
                                            currentSelection.includes(idx) ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-slate-300 bg-white']">
                                        <i v-if="currentSelection.includes(idx)" class="ri-check-line text-sm"></i>
                                    </div>
                                    <span class="text-slate-700 font-medium">{{ opt }}</span>
                                </div>

                                <!-- ç»“æœåé¦ˆå›¾æ ‡ (ä»…åœ¨å·²å›ç­”çŠ¶æ€æ˜¾ç¤º) -->
                                <i v-if="quizAnswered && quizQueue[currentQuizIndex].correct.includes(idx)" class="ri-checkbox-circle-fill text-green-500 text-2xl z-10 absolute right-4"></i>
                                <i v-if="quizAnswered && currentSelection.includes(idx) && !quizQueue[currentQuizIndex].correct.includes(idx)" class="ri-close-circle-fill text-red-500 text-2xl z-10 absolute right-4"></i>
                            </button>
                        </div>

                        <!-- æäº¤æŒ‰é’® (ä»…å¤šé€‰æˆ–æœªç­”é¢˜æ—¶æ˜¾ç¤º) -->
                        <div v-if="!quizAnswered && quizQueue[currentQuizIndex].type === 'multiple'" class="mt-6 flex justify-end">
                            <button @click="submitAnswer" :disabled="currentSelection.length === 0" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-50 transition">
                                æäº¤ç­”æ¡ˆ
                            </button>
                        </div>

                        <!-- è§£æä¸æ§åˆ¶æ  -->
                        <div v-if="quizAnswered" class="mt-8 p-5 bg-slate-50 rounded-xl border border-slate-100 animate-fade-in">
                            <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i class="ri-book-open-line text-indigo-500"></i> è§£æ
                            </h4>
                            <p class="text-sm text-slate-600 leading-relaxed">{{ quizQueue[currentQuizIndex].explanation }}</p>

                            <div class="mt-6 flex justify-end gap-3">
                                <button v-if="currentQuizIndex < quizQueue.length - 1" @click="nextQuestion" class="text-indigo-600 text-sm font-bold hover:underline flex items-center gap-1 px-4 py-2">
                                    ä¸‹ä¸€é¢˜ <i class="ri-arrow-right-line"></i>
                                </button>
                                <button v-else @click="resetQuiz" class="bg-slate-800 text-white text-sm font-bold rounded-lg px-6 py-2 hover:bg-slate-900 transition">
                                    å®Œæˆæµ‹è¯• (å†æ¥ä¸€ç»„)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    const { createApp, ref, onMounted, nextTick, watch, reactive, computed } = Vue;

    createApp({
        setup() {
            // === çŠ¶æ€å®šä¹‰ ===
            const currentTab = ref('mindmap');
            const showConfigModal = ref(false);
            const isTesting = ref(false);
            const connectionStatus = ref(null);
            const connectionMsg = ref('');

            // AI é…ç½® (Persistence)
            const aiConfig = reactive({
                provider: localStorage.getItem('art_ai_provider') || 'custom',
                baseUrl: localStorage.getItem('art_ai_base') || 'https://agent.hzau.edu.cn/api',
                key: localStorage.getItem('art_ai_key') || 'application-925663dee76d1fb36e595f8fa7e17a8f',
                model: localStorage.getItem('art_ai_model') || 'qwen3-235b-a22b-instruct-2507'
            });

            const defaultMarkdown = `# è‰ºæœ¯å­¦æ¦‚è®º\n## ç¬¬ä¸€ç«  è‰ºæœ¯çš„æœ¬è´¨\n### ç¤¾ä¼šæœ¬è´¨\nè‰ºæœ¯åœ¨æœ¬è´¨ä¸Šå±äºä¸Šå±‚å»ºç­‘ä¸­çš„æ„è¯†å½¢æ€ï¼Œå®ƒåæ˜ äº†ç»æµåŸºç¡€ï¼Œå¹¶ä¸ºç»æµåŸºç¡€æœåŠ¡ã€‚\n### è®¤è¯†æœ¬è´¨\nè‰ºæœ¯æ˜¯ä¸»ä½“å¯¹å®¢ä½“çš„åæ˜ ï¼Œä½†è¿™ç§åæ˜ ä¸æ˜¯æœºæ¢°çš„ã€è¢«åŠ¨çš„ç…§é•œå­ï¼Œè€Œæ˜¯èƒ½åŠ¨çš„ã€å®¡ç¾çš„åæ˜ ã€‚\n### å®¡ç¾æœ¬è´¨\nè‰ºæœ¯æ˜¯äººä¸ç°å®çš„å®¡ç¾å…³ç³»ã€‚ç¾æ˜¯è‰ºæœ¯çš„æ ¸å¿ƒã€‚\n## ç¬¬äºŒç«  è‰ºæœ¯çš„èµ·æº\n### æ¨¡ä»¿è¯´\næ¨¡ä»¿è¯´æ˜¯è¥¿æ–¹æœ€å¤è€çš„è‰ºæœ¯èµ·æºç†è®ºã€‚å¤å¸Œè…Šå“²å­¦å®¶äºšé‡Œå£«å¤šå¾·è®¤ä¸ºï¼Œè‰ºæœ¯æ˜¯å¯¹ç°å®çš„æ¨¡ä»¿ã€‚\n### æ¸¸æˆè¯´\næ¸¸æˆè¯´ç”±å¾·å›½å“²å­¦å®¶å¸­å‹’å’Œè‹±å›½å“²å­¦å®¶æ–¯å®¾å¡æå‡ºã€‚\n### è¡¨ç°è¯´\nè¡¨ç°è¯´è®¤ä¸ºè‰ºæœ¯æ˜¯è‰ºæœ¯å®¶æƒ…æ„Ÿçš„è¡¨ç°ã€‚\n### å·«æœ¯è¯´\nå·«æœ¯è¯´è®¤ä¸ºè‰ºæœ¯èµ·æºäºåŸå§‹æ°‘æ—çš„å·«æœ¯ä»ªå¼ã€‚\n### åŠ³åŠ¨è¯´\nåŠ³åŠ¨è¯´è®¤ä¸ºè‰ºæœ¯èµ·æºäºåŠ³åŠ¨ã€‚`;

            // Markdown Data (Persistence)
            const markdownSource = ref(localStorage.getItem('art_markdown_source') || defaultMarkdown);

            const mapSearchQuery = ref('');
            const selectedChapter = ref('');
            let myChart = null;

            const chapterList = computed(() => {
                const matches = markdownSource.value.match(/^(?:##)\s+(.+)$/gm);
                if (!matches) return [];
                return matches.map(h => h.replace(/^##\s+/, '').trim());
            });
            const termList = ref([]);

            const textToRecite = ref('');
            const clozeResult = ref(null);
            const reciteList = ref([]);

            const isAiProcessing = ref(false);
            const quizQueue = ref([]);
            const currentQuizIndex = ref(0);
            const currentSelection = ref([]);
            const quizAnswered = ref(false);

            const tabs = [
                { id: 'mindmap', name: 'æ€ç»´å¯¼å›¾', icon: 'ri-node-tree' },
                { id: 'terms', name: 'åè¯è§£é‡Š', icon: 'ri-book-read-line' },
                { id: 'recite', name: 'èƒŒè¯µæŒ–ç©º', icon: 'ri-eraser-line' },
                { id: 'quiz', name: 'æ¨¡æ‹Ÿæµ‹è¯•', icon: 'ri-question-answer-line' }
            ];

            const currentTabName = computed(() => tabs.find(t => t.id === currentTab.value)?.name);

            const uuidv4 = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });

            const getChapterContent = (fullText, chapterTitle) => {
                if (!chapterTitle) return fullText;
                const lines = fullText.split('\n');
                let startLine = -1, endLine = -1;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.endsWith(chapterTitle) && line.startsWith('##')) { startLine = i; continue; }
                    if (startLine !== -1 && i > startLine && line.startsWith('## ')) { endLine = i; break; }
                }
                if (startLine === -1) return fullText;
                if (endLine === -1) endLine = lines.length;
                return lines.slice(startLine, endLine).join('\n');
            };

            const getChapterFromIndex = (fullText, sliceIndex) => {
                const textBefore = fullText.substring(0, sliceIndex);
                const matches = [...textBefore.matchAll(/^##\s+(.+)$/gm)];
                return matches.length > 0 ? matches[matches.length - 1][1] : "å…¨ä¹¦ç»ªè®º/ç»¼åˆ";
            };

            // ä¼˜åŒ–åˆ‡ç‰‡ï¼š500å­—
            const getRandomSliceWithInfo = (text, maxLength = 500) => {
                if (text.length <= maxLength) return { text, startIndex: 0 };

                const maxStart = text.length - maxLength;
                let start = Math.floor(Math.random() * maxStart);
                while (start > 0 && text[start] !== '\n') start--;

                let end = start + maxLength;
                while (end < text.length && text[end] !== '\n') end++;

                return { text: text.substring(start, end), startIndex: start };
            };

            const callLLM = async (messages, jsonMode = false) => {
                if (aiConfig.provider === 'openai') return callOpenAILLM(messages, jsonMode);
                else return callCustomLLM(messages[messages.length - 1].content);
            };

            const callOpenAILLM = async (messages, jsonMode) => {
                if (!aiConfig.key) { showConfigModal.value = true; throw new Error("è¯·å…ˆé…ç½® API Key"); }
                let endpoint = aiConfig.baseUrl.trim().replace(/\/+$/, '');
                if (!endpoint.endsWith('/chat/completions')) endpoint = `${endpoint}/chat/completions`;
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.key}` },
                        body: JSON.stringify({ model: aiConfig.model, messages: messages, temperature: 0.7, response_format: jsonMode ? { type: "json_object" } : undefined })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) { console.error("OpenAI Error:", error); throw error; }
            };

            const callCustomLLM = async (prompt) => {
                let baseUrl = aiConfig.baseUrl.trim().replace(/\/+$/, '');
                const chatId = uuidv4();
                const url = `${baseUrl}/application/chat_message/${chatId}`;
                const headers = { 'Content-Type': 'application/json' };
                if (aiConfig.key && aiConfig.key.trim()) headers['Authorization'] = `Bearer ${aiConfig.key.trim()}`;

                const bodyPayload = { message: prompt, re_chat: false, stream: false };
                if (aiConfig.model && aiConfig.model.trim()) bodyPayload.model = aiConfig.model.trim();

                try {
                    const response = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(bodyPayload) });
                    if (!response.ok) throw new Error(`Custom API Error: ${response.status}`);
                    const data = await response.json();
                    if (data && typeof data === 'object') {
                        if (data.message) return data.message;
                        if (data.data) return typeof data.data === 'string' ? data.data : JSON.stringify(data.data);
                        if (data.content) return data.content;
                        if (data.answer) return data.answer;
                    }
                    return JSON.stringify(data);
                } catch (error) { console.error("Custom API Error:", error); throw error; }
            };

            const loadPreset = (type) => {
                if (type === 'hzau') {
                    aiConfig.provider = 'custom';
                    aiConfig.baseUrl = 'https://agent.hzau.edu.cn/api';
                    aiConfig.key = 'application-925663dee76d1fb36e595f8fa7e17a8f';
                    aiConfig.model = 'qwen3-235b-a22b-instruct-2507';
                } else if (type === 'deepseek') {
                    aiConfig.provider = 'openai';
                    aiConfig.baseUrl = 'https://api.deepseek.com';
                    aiConfig.key = 'sk-4c8bca2f03834cb9a41355dec5dcc2f4';
                    aiConfig.model = 'deepseek-chat';
                } else if (type === 'gemini') {
                    aiConfig.provider = 'openai';
                    aiConfig.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/openai';
                    aiConfig.key = '';
                    aiConfig.model = 'gemini-1.5-flash';
                }
            };

            const generateTermsBatch = async () => {
                isAiProcessing.value = true;
                termList.value = [];
                const scopeText = getChapterContent(markdownSource.value, selectedChapter.value);
                const promises = [];
                const REQUEST_COUNT = 7;

                for (let i = 0; i < REQUEST_COUNT; i++) {
                    promises.push((async () => {
                        try {
                            const sliceInfo = getRandomSliceWithInfo(scopeText);
                            let sourceChapter = selectedChapter.value;
                            if (!sourceChapter) sourceChapter = getChapterFromIndex(markdownSource.value, sliceInfo.startIndex);

                            const randomSeed = Math.floor(Math.random() * 999999);
                            const focusInstruction = ["è¯·å…³æ³¨æ–‡æœ¬å¼€å¤´çš„æ¦‚å¿µ", "è¯·å…³æ³¨æ–‡æœ¬ç»“å°¾çš„æ¦‚å¿µ", "è¯·æ‰¾ä¸€ä¸ªæœ€å†·é—¨çš„åè¯", "è¯·æ‰¾ä¸€ä¸ªå­—æ•°æœ€å°‘çš„åè¯", "è¯·éšæœºæŒ‘é€‰ä¸€ä¸ª", "è¯·æ‰¾ä¸€ä¸ªè§£é‡Šæœ€é•¿çš„åè¯", "è¯·æ‰¾ä¸€ä¸ªå’Œ 'è‰ºæœ¯' å…³è”æœ€ç´§å¯†çš„åè¯"][i % 7];

                            const prompt = `è¯·ä½œä¸ºä¸€ä½ä¸¥è°¨çš„å­¦æœ¯åŠ©æ‰‹ï¼Œé˜…è¯»ä»¥ä¸‹æ–‡æœ¬ç‰‡æ®µï¼Œå¹¶ä»ä¸­ç­›é€‰ä¸€ä¸ª**åˆè§„çš„è€ƒè¯•åè¯**ã€‚

                                **ä¸¥æ ¼ç­›é€‰æ ‡å‡†**ï¼š
                                1. **ç»“æ„ä½ç½®**ï¼šç›®æ ‡åè¯å¿…é¡»æ˜¯**æ®µè½å¼€å¤´çš„ä¸»è¯­**ï¼ˆå¦‚ "åè¯ï¼šè§£é‡Š" æˆ– "## åè¯"ï¼‰ï¼Œæˆ–è€…æ˜¯**åˆ—è¡¨é¡¹çš„å¼€å¤´**ï¼ˆå¦‚ "- åè¯"ï¼‰ã€‚
                                2. **ä¸¥ç¦è¡Œä¸º**ï¼šç»å¯¹**ç¦æ­¢**æå–å¥å­ä¸­é—´çš„è¯ã€‚ç»å¯¹**ç¦æ­¢**æå–å•ä¸ªæ±‰å­—ã€‚

                                **è¾“å‡ºä»»åŠ¡**ï¼š
                                1. æå–ä¸€ä¸ªç¬¦åˆä¸Šè¿°æ ‡å‡†çš„æ ¸å¿ƒåè¯ã€‚
                                2. **æ·±åº¦æº¯æºä¸åŒºåˆ†**ï¼šå°†æ–‡ä¸­å…³äºè¯¥åè¯çš„æ‰€æœ‰æè¿°æ•´ç†æˆæ•°ç»„ã€‚å¦‚æœæ˜¯åŸæ–‡åŸè¯ï¼Œæ ‡è®°ä¸º "original"ï¼›å¦‚æœæ˜¯ä½ æ·»åŠ çš„è¿æ¥è¯ï¼Œæ ‡è®°ä¸º "ai_summary"ã€‚
                                3. ç”Ÿæˆ"è¯­å¢ƒæç¤º"ï¼šæè¿°èƒŒæ™¯ï¼Œä¸å«åè¯æœ¬èº«ã€‚

                                **ç‰¹æ®ŠæŒ‡ä»¤**ï¼š${focusInstruction} (éšæœºå› å­: ${randomSeed})

                                æ–‡æœ¬ç‰‡æ®µï¼š
                                ===
                                ${sliceInfo.text}
                                ===

                                ä¸¥æ ¼è¿”å› JSON æ ¼å¼ï¼š
                                {
                                    "term": "åè¯åç§°",
                                    "context": "è¯­å¢ƒæç¤º...",
                                    "definition_segments": [
                                        { "text": "åŸæ–‡å¥å­...", "is_original": true },
                                        { "text": "AIè¿æ¥è¯...", "is_original": false }
                                    ]
                                }`;

                            const res = await callLLM([{ role: "user", content: prompt }], true);
                            const cleanRes = res.replace(/```json\n?|\n?```/g, '').trim();
                            const json = JSON.parse(cleanRes);
                            return {
                                term: json.term,
                                context: json.context,
                                segments: json.definition_segments,
                                chapter: sourceChapter,
                                revealed: false
                            };
                        } catch (e) { console.error("Single term gen failed", e); return null; }
                    })());
                }

                const results = await Promise.all(promises);
                const uniqueResults = [];
                const seenTerms = new Set();
                for (const item of results) {
                    if (item && item.term && !seenTerms.has(item.term)) {
                        seenTerms.add(item.term);
                        uniqueResults.push(item);
                    }
                }
                termList.value = uniqueResults.slice(0, 5);
                isAiProcessing.value = false;
            };

            const generateReciteBatch = async () => {
                isAiProcessing.value = true;
                reciteList.value = [];
                try {
                    const chapterText = getChapterContent(markdownSource.value, selectedChapter.value);
                    const sliceInfo = getRandomSliceWithInfo(chapterText);
                    const prompt = `è¯·é˜…è¯»ä»¥ä¸‹æ–‡æœ¬ç‰‡æ®µï¼Œä»ä¸­æå– **3æ®µ** ä¸åŒçš„æ ¸å¿ƒçŸ¥è¯†ç‚¹æ®µè½ï¼ˆæ¯æ®µçº¦100å­—å·¦å³ï¼‰ï¼Œç”¨äºåˆ¶ä½œå¡«ç©ºèƒŒè¯µå¡ã€‚
                        å¯¹äºæ¯ä¸€æ®µï¼Œè¯·è¿›è¡Œ**é€‚åº¦æŒ–ç©º**ï¼ˆæŒ–æ‰20%-30%çš„è¯ï¼ŒåŒ…æ‹¬å…³é”®è¯ã€å±æ€§è¯ã€è¿æ¥è¯ï¼Œä¸è¦åªæŒ–ä¸»è¯­ï¼‰ã€‚ä¿è¯å‰©ä¸‹çš„æ–‡å­—ä¾ç„¶é€šé¡ºå¯è¯»ã€‚

                        æ–‡æœ¬ç‰‡æ®µï¼š
                        ${sliceInfo.text}

                        ä¸¥æ ¼è¿”å› JSON æ ¼å¼ï¼š
                        {
                            "items": [
                                {
                                    "segments": [
                                        { "type": "text", "content": "åŸæ–‡..." },
                                        { "type": "cloze", "content": "è¢«æŒ–ç©ºçš„è¯" },
                                        { "type": "text", "content": "..." }
                                    ]
                                },
                                ... (å…±3é¡¹)
                            ]
                        }`;

                    const res = await callLLM([{ role: "user", content: prompt }], true);
                    const cleanRes = res.replace(/```json\n?|\n?```/g, '').trim();
                    const json = JSON.parse(cleanRes);

                    json.items.forEach(item => {
                        item.segments.forEach(s => { if(s.type==='cloze') s.revealed = false; });
                    });
                    reciteList.value = json.items;
                } catch (e) { alert(`ç”Ÿæˆå¤±è´¥: ${e.message}`); } finally { isAiProcessing.value = false; }
            };

            const toggleAllCloze = (state) => {
                reciteList.value.forEach(item => {
                    item.segments.forEach(s => { if(s.type === 'cloze') s.revealed = state; });
                });
            };

            const generateQuizBatch = async () => {
                isAiProcessing.value = true;
                quizQueue.value = [];
                currentQuizIndex.value = 0;
                quizAnswered.value = false;
                currentSelection.value = [];

                try {
                    const chapterText = getChapterContent(markdownSource.value, selectedChapter.value);
                    const sliceInfo = getRandomSliceWithInfo(chapterText);
                    const prompt = `è¯·é˜…è¯»ä»¥ä¸‹æ–‡æœ¬ç‰‡æ®µï¼Œæ ¹æ®å…¶ä¸­çš„å†…å®¹å‡º **5é“** é€‰æ‹©é¢˜ã€‚

                        è¦æ±‚ï¼š
                        1. å‰ 4 é“ä¸º**å•é¡¹é€‰æ‹©é¢˜** (type: 'single')ã€‚
                        2. ç¬¬ 5 é“å¿…é¡»ä¸º**ä¸å®šé¡¹é€‰æ‹©é¢˜** (type: 'multiple')ï¼Œå³æ­£ç¡®ç­”æ¡ˆå¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªã€‚

                        æ–‡æœ¬ç‰‡æ®µï¼š
                        ===
                        ${sliceInfo.text}
                        ===

                        ä¸¥æ ¼è¿”å› JSON æ•°ç»„æ ¼å¼ï¼š
                        [
                            {
                                "type": "single",
                                "question": "é¢˜ç›®1...",
                                "options": ["A", "B", "C", "D"],
                                "correct": [0], // å•é€‰æ•°ç»„é‡Œåªæœ‰ä¸€ä¸ªç´¢å¼•
                                "explanation": "è§£æ..."
                            },
                            ...
                            {
                                "type": "multiple",
                                "question": "é¢˜ç›®5(ä¸å®šé¡¹)...",
                                "options": ["A", "B", "C", "D", "E"],
                                "correct": [0, 2], // å¤šé€‰æ•°ç»„é‡Œæœ‰å¤šä¸ªç´¢å¼•
                                "explanation": "è§£æ..."
                            }
                        ]`;

                    const res = await callLLM([{ role: "user", content: prompt }], true);
                    const cleanRes = res.replace(/```json\n?|\n?```/g, '').trim();
                    const json = JSON.parse(cleanRes);

                    quizQueue.value = json;
                } catch (e) { alert(`å‡ºé¢˜å¤±è´¥: ${e.message}`); } finally { isAiProcessing.value = false; }
            };

            const selectOption = (idx) => {
                const currentQ = quizQueue.value[currentQuizIndex.value];
                if (quizAnswered.value) return;
                if (currentQ.type === 'single') {
                    currentSelection.value = [idx];
                    quizAnswered.value = true;
                } else {
                    const pos = currentSelection.value.indexOf(idx);
                    if (pos > -1) currentSelection.value.splice(pos, 1);
                    else currentSelection.value.push(idx);
                }
            };

            const submitAnswer = () => { quizAnswered.value = true; };
            const nextQuestion = () => { if (currentQuizIndex.value < quizQueue.value.length - 1) { currentQuizIndex.value++; quizAnswered.value = false; currentSelection.value = []; } };
            const resetQuiz = () => { generateQuizBatch(); };

            const getOptionClass = (idx) => {
                const currentQ = quizQueue.value[currentQuizIndex.value];
                if (!quizAnswered.value) {
                    return currentSelection.value.includes(idx)
                        ? 'bg-indigo-50 border-indigo-500 ring-1 ring-indigo-200'
                        : 'bg-white border-slate-200 hover:border-indigo-300';
                }
                const isCorrect = currentQ.correct.includes(idx);
                const isSelected = currentSelection.value.includes(idx);
                if (isCorrect) return 'bg-green-50 border-green-500 ring-1 ring-green-500';
                if (isSelected && !isCorrect) return 'bg-red-50 border-red-500 ring-1 ring-red-200';
                return 'bg-slate-50 border-slate-200 opacity-60';
            };

            const parseMarkdown = (md) => {
                const lines = md.split('\n');
                const root = { name: 'è‰ºæœ¯å­¦æ¦‚è®º', children: [] };
                const stack = [{ node: root, level: 0 }];
                lines.forEach(line => {
                    const match = line.match(/^(#+)\s+(.*)/);
                    if (match) {
                        const level = match[1].length;
                        const newNode = { name: match[2].trim(), children: [] };
                        while (stack.length > 0 && stack[stack.length - 1].level >= level) stack.pop();
                        stack[stack.length - 1].node.children.push(newNode);
                        stack.push({ node: newNode, level });
                    }
                });
                return root.children.length === 1 ? root.children[0] : root;
            };

            const renderMindMap = () => {
                const data = parseMarkdown(markdownSource.value);
                const chartDom = document.getElementById('mindmap-container');
                if (!chartDom) return;
                if (myChart) myChart.dispose();
                myChart = echarts.init(chartDom);
                myChart.setOption({
                    tooltip: { trigger: 'item', triggerOn: 'mousemove' },
                    series: [{ type: 'tree', data: [data], top: '5%', bottom: '5%', left: '10%', right: '20%', symbolSize: 10, roam: true, label: { position: 'left', verticalAlign: 'middle', align: 'right', fontSize: 14 }, leaves: { label: { position: 'right', verticalAlign: 'middle', align: 'left' } }, expandAndCollapse: true, initialTreeDepth: 2, lineStyle: { curveness: 0.5 } }]
                });
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    markdownSource.value = e.target.result;
                    nextTick(renderMindMap);
                };
                reader.readAsText(file);
                event.target.value = '';
            };
            const resetMindMapZoom = () => myChart && myChart.dispatchAction({ type: 'restore' });
            const searchMindMap = () => renderMindMap();
            const testConnection = async () => { isTesting.value = true; try { await callLLM([{ role: "user", content: "Hi" }]); connectionStatus.value = 'success'; connectionMsg.value = 'è¿æ¥æˆåŠŸï¼'; setTimeout(() => showConfigModal.value = false, 1000); saveConfig(); } catch (e) { connectionStatus.value = 'error'; connectionMsg.value = e.message; } finally { isTesting.value = false; } };
            const saveConfig = () => {
                localStorage.setItem('art_ai_provider', aiConfig.provider);
                localStorage.setItem('art_ai_base', aiConfig.baseUrl);
                localStorage.setItem('art_ai_key', aiConfig.key);
                localStorage.setItem('art_ai_model', aiConfig.model);
            };

            // æ–‡æ¡£è‡ªåŠ¨ä¿å­˜ç›‘å¬å™¨
            watch(markdownSource, (newVal) => {
                localStorage.setItem('art_markdown_source', newVal);
            });

            watch(currentTab, (val) => { if (val === 'mindmap') nextTick(renderMindMap); });
            onMounted(() => { renderMindMap(); window.addEventListener('resize', () => myChart && myChart.resize()); });

            return {
                currentTab, tabs, currentTabName, showConfigModal, aiConfig, isTesting, connectionStatus, connectionMsg,
                markdownSource, mapSearchQuery, chapterList, selectedChapter, termList, generateTermsBatch,
                textToRecite, clozeResult, isAiProcessing, generateReciteBatch, toggleAllCloze,
                quizQueue, currentQuizIndex, currentSelection, quizAnswered, generateQuizBatch, selectOption, submitAnswer, nextQuestion, resetQuiz, getOptionClass,
                testConnection, saveConfig, renderMindMap, handleFileUpload, resetMindMapZoom, searchMindMap, loadPreset, reciteList
            };
        }
    }).mount('#app');
</script>
</body>
</html>